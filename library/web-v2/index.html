<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Library - Audiobook Collection</title>
    <link rel="stylesheet" href="css/library.css">
    <link rel="stylesheet" href="css/auth.css">
    <link rel="stylesheet" href="css/notifications.css">
</head>
<body>
    <!-- Header -->
    <header class="library-header">
        <div class="header-content">
            <div class="title-section">
                <h1 class="library-title">The Library</h1>
                <p class="library-subtitle">A Private Collection of Audiobooks</p>
            </div>
            <div class="header-nav">
                <!-- User menu (shown when logged in) -->
                <div id="user-menu" class="user-menu" hidden>
                    <button class="user-button" id="user-menu-button" title="Account options">
                        <span class="user-icon" id="user-initial">?</span>
                        <span id="username-display">User</span>
                    </button>
                    <div class="user-dropdown" id="user-dropdown">
                        <a href="#" class="user-dropdown-item" id="edit-profile-button" title="Change your username">Edit Profile</a>
                        <a href="contact.html" class="user-dropdown-item" title="Send a message to the admin">Contact Admin</a>
                        <div class="user-dropdown-divider"></div>
                        <a href="#" class="user-dropdown-item" id="logout-button">Sign Out</a>
                    </div>
                </div>

                <!-- Login link (shown when auth enabled but not logged in) -->
                <a href="login.html" id="login-link" class="utilities-link" hidden title="Sign in to access The Library">
                    <span class="utilities-text">Sign In</span>
                </a>

                <!-- Back Office link (admin only - controlled by JavaScript) -->
                <a href="utilities.html" id="admin-backoffice-link" class="utilities-link" hidden title="Library Administration">
                    <span class="utilities-icon">&#9881;</span>
                    <span class="utilities-text">Back Office</span>
                </a>
            </div>
        </div>

        <div class="library-stats">
            <div class="stat-item">
                <span class="stat-value" id="total-books">-</span>
                <span class="stat-label">volumes</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="total-hours">-</span>
                <span class="stat-label">hours</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="total-authors">-</span>
                <span class="stat-label">authors</span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="total-narrators">-</span>
                <span class="stat-label">narrators</span>
            </div>
        </div>
    </header>

    <!-- Notification Banners -->
    <div id="notification-container" class="notification-container"></div>

    <!-- Search and Filters -->
    <div class="search-section">
        <div class="search-container">
            <input type="text"
                   id="search-input"
                   class="search-input"
                   placeholder="Search books, authors, narrators...">
            <button id="clear-search" class="clear-btn">Clear</button>
        </div>

        <div class="filters-container">
            <div class="author-autocomplete" id="author-autocomplete">
                <div class="author-controls">
                    <div class="letter-groups">
                        <button class="letter-group active" data-group="all">All</button>
                        <button class="letter-group" data-group="a-e">A-E</button>
                        <button class="letter-group" data-group="f-j">F-J</button>
                        <button class="letter-group" data-group="k-o">K-O</button>
                        <button class="letter-group" data-group="p-t">P-T</button>
                        <button class="letter-group" data-group="u-z">U-Z</button>
                    </div>
                    <button class="sort-toggle" id="author-sort" title="Toggle sort order">A-Z</button>
                </div>
                <div class="author-search-row">
                    <input type="text"
                           id="author-search"
                           class="filter-select author-input"
                           placeholder="Search authors..."
                           autocomplete="off">
                    <button id="author-clear" class="author-clear" title="Clear author filter">&times;</button>
                </div>
                <div class="author-dropdown" id="author-dropdown"></div>
            </div>

            <div class="narrator-autocomplete" id="narrator-autocomplete">
                <div class="narrator-controls">
                    <div class="letter-groups">
                        <button class="letter-group active" data-group="all">All</button>
                        <button class="letter-group" data-group="a-e">A-E</button>
                        <button class="letter-group" data-group="f-j">F-J</button>
                        <button class="letter-group" data-group="k-o">K-O</button>
                        <button class="letter-group" data-group="p-t">P-T</button>
                        <button class="letter-group" data-group="u-z">U-Z</button>
                    </div>
                    <button class="sort-toggle" id="narrator-sort" title="Toggle sort order">A-Z</button>
                </div>
                <div class="narrator-search-row">
                    <input type="text"
                           id="narrator-search"
                           class="filter-select narrator-input"
                           placeholder="Search narrators..."
                           autocomplete="off">
                    <button id="narrator-clear" class="narrator-clear" title="Clear narrator filter">&times;</button>
                </div>
                <div class="narrator-dropdown" id="narrator-dropdown"></div>
            </div>

            <select id="sort-filter" class="filter-select">
                <optgroup label="Title">
                    <option value="title:asc">Title (A-Z)</option>
                    <option value="title:desc">Title (Z-A)</option>
                </optgroup>
                <optgroup label="Author">
                    <option value="author_last:asc">Author Last Name (A-Z)</option>
                    <option value="author_last:desc">Author Last Name (Z-A)</option>
                    <option value="author_first:asc">Author First Name (A-Z)</option>
                    <option value="author_first:desc">Author First Name (Z-A)</option>
                    <option value="author:asc">Author Full Name (A-Z)</option>
                    <option value="author:desc">Author Full Name (Z-A)</option>
                </optgroup>
                <optgroup label="Narrator">
                    <option value="narrator_last:asc">Narrator Last Name (A-Z)</option>
                    <option value="narrator_last:desc">Narrator Last Name (Z-A)</option>
                    <option value="narrator_first:asc">Narrator First Name (A-Z)</option>
                    <option value="narrator_first:desc">Narrator First Name (Z-A)</option>
                </optgroup>
                <optgroup label="Duration">
                    <option value="duration_hours:desc">Longest First</option>
                    <option value="duration_hours:asc">Shortest First</option>
                </optgroup>
                <optgroup label="Dates">
                    <option value="acquired_date:desc">Recently Acquired</option>
                    <option value="acquired_date:asc">Oldest Acquired</option>
                    <option value="published_year:desc">Newest Published</option>
                    <option value="published_year:asc">Oldest Published</option>
                </optgroup>
                <optgroup label="Series &amp; Editions">
                    <option value="series:asc">Series (A-Z with sequence)</option>
                    <option value="series:desc">Series (Z-A with sequence)</option>
                    <option value="edition:asc">Edition (A-Z)</option>
                </optgroup>
            </select>

            <button id="refresh-btn" class="refresh-btn">↻ Refresh</button>
        </div>
    </div>

    <!-- Collections Sidebar -->
    <div class="sidebar-overlay" id="sidebar-overlay"></div>
    <aside class="collections-sidebar" id="collections-sidebar">
        <div class="sidebar-header">
            <h2>Collections</h2>
            <button class="sidebar-close" id="sidebar-close" title="Close sidebar">&times;</button>
        </div>
        <div class="sidebar-content" id="collections-buttons">
            <!-- Collection buttons loaded dynamically -->
        </div>
        <div class="sidebar-footer">
            <button class="sidebar-clear" id="sidebar-clear-filter">Clear Filter</button>
        </div>
    </aside>

    <!-- Results Info with Sidebar Toggle -->
    <div class="results-info">
        <div class="results-left">
            <button class="sidebar-toggle" id="sidebar-toggle" title="Browse Collections">
                <span class="toggle-icon">☰</span>
                <span class="toggle-text">Collections</span>
                <span class="active-filter" id="active-filter-badge"></span>
            </button>
            <p id="showing-count">Loading...</p>
        </div>
        <div class="pagination-controls" id="top-pagination"></div>
    </div>

    <!-- Audiobooks Grid -->
    <div class="books-grid" id="books-grid">
        <!-- Books will be loaded here -->
    </div>

    <!-- Pagination -->
    <div class="pagination-section">
        <div class="pagination-controls" id="bottom-pagination"></div>
        <div class="per-page-control">
            <label for="per-page">Items per page:</label>
            <select id="per-page" class="filter-select">
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
                <option value="200">200</option>
            </select>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <p>Loading audiobooks...</p>
    </div>

    <!-- Audio Player -->
    <div class="audio-player" id="audio-player" style="display: none;">
        <button class="player-close" id="close-player">×</button>

        <div class="player-info">
            <img id="player-cover" src="" alt="" class="player-cover">
            <div class="player-meta">
                <div class="player-title" id="player-title">-</div>
                <div class="player-author" id="player-author">-</div>
                <div class="player-file-info" id="player-file-info">
                    <span class="player-id" id="player-id">ID: -</span>
                    <span class="player-path" id="player-path" title="">-</span>
                </div>
            </div>
        </div>

        <div class="player-controls">
            <button class="control-btn" id="play-pause">▶</button>
            <div class="time-info">
                <span id="current-time">0:00</span>
                <span> / </span>
                <span id="total-time">0:00</span>
            </div>
        </div>

        <div class="progress-container">
            <input type="range" id="progress-bar" class="progress-bar" min="0" max="100" value="0">
        </div>

        <div class="player-extras">
            <button class="control-btn small-btn" id="rewind">-30s</button>
            <button class="control-btn small-btn" id="forward">+30s</button>
            <input type="range" id="volume" class="volume-slider" min="0" max="100" value="100">
            <span id="playback-speed">1x</span>
            <button class="control-btn small-btn" id="speed-btn">Speed</button>
        </div>

        <audio id="audio-element"></audio>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal" id="edit-profile-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Profile</h2>
                <button class="modal-close" id="edit-profile-close" title="Close dialog">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-profile-form">
                    <div class="form-group">
                        <label for="edit-profile-username">Username</label>
                        <input type="text" id="edit-profile-username" name="username"
                               minlength="3" maxlength="32"
                               title="3-32 characters"
                               required>
                        <span class="field-hint">3-32 characters (spaces allowed, no &lt; &gt; \\ characters)</span>
                    </div>
                    <div class="form-group">
                        <label for="edit-profile-email">Email (optional)</label>
                        <input type="email" id="edit-profile-email" name="email"
                               placeholder="user@example.com"
                               title="Email address for notifications">
                        <span class="field-hint">Used for account recovery and notifications</span>
                    </div>
                </form>
                <div id="edit-profile-error" class="error-message" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button class="auth-button secondary" id="edit-profile-cancel" title="Cancel changes">Cancel</button>
                <button class="auth-button" id="edit-profile-save" title="Save changes">Save</button>
            </div>
        </div>
    </div>

    <script src="js/library.js"></script>
    <script>
        // User menu dropdown handling
        document.addEventListener('DOMContentLoaded', () => {
            const menuButton = document.getElementById('user-menu-button');
            const dropdown = document.getElementById('user-dropdown');
            const logoutButton = document.getElementById('logout-button');
            const editProfileButton = document.getElementById('edit-profile-button');

            if (menuButton && dropdown) {
                menuButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    dropdown.classList.toggle('open');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', () => {
                    dropdown.classList.remove('open');
                });

                dropdown.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            }

            if (logoutButton) {
                logoutButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    // Access the library instance and call logout
                    if (window.library) {
                        window.library.logout();
                    }
                });
            }

            // Edit Profile handling
            if (editProfileButton) {
                editProfileButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    dropdown.classList.remove('open');
                    showEditProfileModal();
                });
            }
        });

        async function showEditProfileModal() {
            const modal = document.getElementById('edit-profile-modal');
            const usernameEl = document.getElementById('edit-profile-username');
            const emailEl = document.getElementById('edit-profile-email');
            const saveBtn = document.getElementById('edit-profile-save');
            const cancelBtn = document.getElementById('edit-profile-cancel');
            const closeBtn = document.getElementById('edit-profile-close');
            const errorEl = document.getElementById('edit-profile-error');

            // Fetch current user data including email
            try {
                const meRes = await fetch('/auth/me', { credentials: 'include' });
                if (meRes.ok) {
                    const meData = await meRes.json();
                    usernameEl.value = meData.user.username || '';
                    emailEl.value = meData.user.email || '';
                }
            } catch (e) {
                // Fall back to displayed username
                usernameEl.value = document.getElementById('username-display')?.textContent || '';
                emailEl.value = '';
            }
            errorEl.style.display = 'none';

            modal.classList.add('active');

            const closeModal = () => modal.classList.remove('active');

            // Clone buttons to remove old event listeners
            const newSaveBtn = saveBtn.cloneNode(true);
            const newCancelBtn = cancelBtn.cloneNode(true);
            const newCloseBtn = closeBtn.cloneNode(true);
            saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);

            newCancelBtn.addEventListener('click', closeModal);
            newCloseBtn.addEventListener('click', closeModal);

            newSaveBtn.addEventListener('click', async () => {
                const newUsername = usernameEl.value.trim();
                const newEmail = emailEl.value.trim();

                if (!newUsername || newUsername.length < 3) {
                    errorEl.textContent = 'Username must be at least 3 characters';
                    errorEl.style.display = 'block';
                    return;
                }
                if (newUsername.length > 32) {
                    errorEl.textContent = 'Username must be at most 32 characters';
                    errorEl.style.display = 'block';
                    return;
                }
                if (/[<>\\]/.test(newUsername)) {
                    errorEl.textContent = 'Username cannot contain < > or \\ characters';
                    errorEl.style.display = 'block';
                    return;
                }
                if (newUsername !== newUsername.trim()) {
                    errorEl.textContent = 'Username cannot have leading or trailing spaces';
                    errorEl.style.display = 'block';
                    return;
                }
                if (newEmail && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(newEmail)) {
                    errorEl.textContent = 'Invalid email format';
                    errorEl.style.display = 'block';
                    return;
                }

                try {
                    const res = await fetch('/auth/me', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            username: newUsername,
                            email: newEmail || null
                        })
                    });

                    if (res.ok) {
                        // Update header display
                        const usernameDisplay = document.getElementById('username-display');
                        const userInitial = document.getElementById('user-initial');
                        if (usernameDisplay) usernameDisplay.textContent = newUsername;
                        if (userInitial) userInitial.textContent = newUsername.charAt(0).toUpperCase();
                        closeModal();
                    } else {
                        const data = await res.json();
                        errorEl.textContent = data.error || 'Failed to update profile';
                        errorEl.style.display = 'block';
                    }
                } catch (error) {
                    errorEl.textContent = 'Connection error';
                    errorEl.style.display = 'block';
                }
            });
        }
    </script>
</body>
</html>
